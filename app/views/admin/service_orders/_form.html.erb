<%= simple_form_for([:admin, @service_order]) do |form| %>
  <%= form.error_notification %>
  <%= form.error_notification message: form.object.errors[:base].to_sentence if form.object.errors[:base].present? %>
            <!-- START card-->
            <div class="card card-default">
               <div class="card-body">
                  
                     <h3></h3>
                     <fieldset>
                        <div class="form-group row">
                           <div class="col-md-12">
                              <div class="form-row">
                                <div class="col-lg-4 mb-4">
                                  <label class="form-label">Fecha de ingreso</label>
                                  <div class="form-group"> 
                                    <%= form.text_field :date_admission, class: "form-control" , placeholder: "Ingreso", type: 'date', value: (form.object.date_admission ? form.object.date_admission.to_date : '')%>
                                  </div>  
                                </div> 
                                <div class="col-lg-4 mb-4x">
                                </br></br>
                                        <%= form.association :type_service_orders, as: :check_boxes %>
                                 </div>
                              </div>
                          </div>
                        </div>

                        <div class="form-group row">
                          <div class="col-md-12">
                            <div class="form-row">
                              <div class="col-lg-8 mb-8">
                                <%= form.association :customer, input_html: { class: 'custom-select custom-select-sm' } %>
                              </div>
                              <div class="col-lg-4 mb-4">
                                </br>
                               <%= link_to new_admin_customer_path, :class => "btn btn-success ml-auto", data: { modal: true }   do %>
                                 <em class="fa fa-plus-circle fa-fw mr-1"></em>Agregar
                               <%end%>                                  
                              </div>
                            </div>
                          </div>

                        </div>
                      </br>

                        <div class="form-group row">
                          <div class="col-md-12">
                            <div class="form-row">
                              <div class="col-lg-8 mb-8">
                              <%if @service_order.product %>
                                        <div class="form-group">
                                          <label class="control-label"><%= t('sale_note_has_products.product')%></label>
                                          <input class="form-control" type="text" value="<%= @service_order.product.name %>" readonly="readonly">
                                        </div>
                              <%else %>
                                        <div class="form-group">
                                          <label class="control-label"><abbr title="required">*</abbr><%= t('sale_note_has_products.product')%></label>
                                           <select class="form-control custom-select custom-select-sm" data-placeholder="Producto" tabindex="1" name='service_order[product_id]' id="service_order_product_id" style="width: 100%">
                                          </select>
                                        </div>
                              <% end %>

                              </div>
                              <div class="col-lg-4 mb-4">
                                </br>
                              </div>
                            </div>
                          </div>

                        </div>
                      </br>

                        <div class="form-group row">
                           <div class="col-md-12">
                              <div class="form-row">
                                 <div class="col-lg-4 mb-4x">
                                        <%= form.label :serie, class: "col-form-label"%> *
                                        <%= form.text_field :serie, class: "form-control", type: "text", required: true %>
                                 </div>

                                  <div class="col-lg-4 mb-4x">
                                        <%= form.label :brand, class: "col-form-label"%> *
                                        <%= form.text_field :brand, class: "form-control", type: "text", required: true %>
                                 </div>

                                 <div class="col-lg-4 mb-4x">
                                        <%= form.label :model, class: "col-form-label"%> *
                                        <%= form.text_field :model, class: "form-control", type: "text", required: true %>
                                 </div>                              


                              </div>
                          </div>
                        </div>
                        </br>
                    
                        <div class="form-group row">
                           <div class="col-md-12">
                              <div class="form-row">
                                 <div class="col-lg-12 mb-12x">
                                        <%= form.file_field :images, multiple: true, class: "mb-1 btn btn-outline-secondary" %>
                                 </div>

                              </div>
                          </div>
                        </div>
                        </br>

                         <% if @service_order.images.attached? %>
                          <div class="form-group row" >
                          <%= form.fields_for :images_attachments do |f| %>
                                    <div class="col-md-3">
                                      <%= image_tag f.object.variant(resize_to_limit: [300, 300]) %>
                                    </div> 
                                    <div class="col-md-3">
                                      <div class="col-md-12">
                                        <label>Eliminar</label> <%= f.check_box :_destroy    %>
                                      </div>
                                    </div>     
                          <% end %>
                          </div>    
                        <% end %>

                        <div class="form-group row">
                          <div class="col-md-12">
                            <div class="form-row">
                              <div class="col-lg-12 mb-12">
                                <label for="validationServer03"><b>Observaciones</b></label>
                                <%= form.text_area :observation, class: "form-control", rows: 10 %>
                              </div>

                            </div>
                          </div>

                        </div>
                      </br>

                          <!-- begin my product -->
                              <!-- Table Products -->
                      <h4 class="box-title m-t-40">Accesorios</h4>
                      <hr>
                                                          
                      <div class="col-lg-12">
                        <div class="white-box" id="">
                          <table id="container_accessories" class="table table-bordered table-hover toggle-circle" data-page-size="7">
                            <thead id="product_head" >
                              <tr>
                                <th class="text-center" data-field="product">Accesorio</th>
                                <th class="text-center" data-field="quantity">Cantidad</th>
                                
                                <!--<th class="text-center" data-field="last_name" data-sort-ignore="true" class="min-width">Eliminar</th>-->
                              </tr>
                            </thead>
                            <tbody>
                                <%if @service_order.order_accessories.first %>
                                  <% @service_order.order_accessories.each_with_index do |item,index| %>
                                    <tr class="text-center" data-id="<%=item.id%>">
                                      <td>
                                      <%= item.accessory %><br>
                                      </td>
                                      
                                      <td>
                                        <input type="number" value="<%=item.quantity%>" name="service_order[order_accessories_attributes][<%=index%>][quantity]"  >
                                      </td>

                                        <input type="hidden" value="<%=item.id%>" name="service_order[order_accessories_attributes][<%=index%>][id]">
                                        <input type="hidden" value="<%=item.service_order_id%>" name="service_order[order_accessories_attributes][<%=index%>][service_order_id]">
                                    </tr>
                                  <%end%>
                                <%end%>                              
                            </tbody>
                              
                          </table>
                        </div>
                      </div>
                      

                     <div class="clearfix">
                        <div class="float-right">
                        <%= form.submit class: "btn btn-primary" %>

                        <%= link_to admin_service_orders_path, :class => "btn btn-secondary" do %>
                            Cancelar
                        <%end%>     
                        </div>
                     </div>
                      
                      </fieldset>
               </div> <!--card-body card-->
            </div>
            <!-- END card-->
<% end %>

<script type="text/javascript">

$("#service_order_customer_id").select2({
  ajax: {
    url: '/admin/<%=controller_name%>/customers',
    dataType: 'json',
    delay: 250,
    data: function (params) {
      return {
        q: {business_name_or_rfc_cont: params.term}, // search term
        page: params.page
      };
    },
    processResults: function (data, params) {
      // parse the results into the format expected by Select2
      // since we are using custom formatting functions we do not need to
      // alter the remote JSON data, except to indicate that infinite
      // scrolling can be used
      params.page = params.page || 1;

      return {
        results: data.customers,
        pagination: {
          more: (params.page * 30) < data.total_count
        }
      };
    },
    cache: true
  },
  placeholder: 'Buscar cliente',
  allowClear: true,
  minimumInputLength: 1,
  templateResult: formatRepo,
  templateSelection: formatRepoSelection
});

function formatRepo (repo) {
  if (repo.loading) {
    return repo.text;
  }

  var $container = $(
    "<div class='select2-result-repository clearfix'>" +
      "<div class='select2-result-repository__meta'>" +
        "<div class='select2-result-repository__id'>ID: </div>" +
        "<div class='select2-result-repository__name'>Nombre: </div>" +
        "<div class='select2-result-repository__rfc'>RFC: </div>" +
        "<div class='select2-result-repository__business_name'>Empresa: </div>" +
      "</div>" +
    "</div>"
  );


  $container.find(".select2-result-repository__id").append(repo.id);
  $container.find(".select2-result-repository__name").append(repo.name);
  $container.find(".select2-result-repository__rfc").append(repo.rfc);
  $container.find(".select2-result-repository__business_name").append(repo.business_name);
  
  return $container;
}

function formatRepoSelection (repo) {
  return repo.rfc || repo.text;
}

</script>

<script type="text/javascript">

$("#service_order_product_id").select2({
  ajax: {
    url: '/admin/<%=controller_name%>/products',
    dataType: 'json',
    delay: 250,
    data: function (params) {
      return {
        q: {name_cont: params.term}, // search term
        page: params.page
      };
    },
    processResults: function (data, params) {
      // parse the results into the format expected by Select2
      // since we are using custom formatting functions we do not need to
      // alter the remote JSON data, except to indicate that infinite
      // scrolling can be used
      params.page = params.page || 1;

      return {
        results: data.products,
        pagination: {
          more: (params.page * 30) < data.total_count
        }
      };
    },
    cache: true
  },
  placeholder: 'Buscar producto',
  allowClear: true,
  minimumInputLength: 1,
  templateResult: formatRepo,
  templateSelection: formatRepoSelection
});

function formatRepo (repo) {
  if (repo.loading) {
    return repo.text;
  }

  var $container = $(
    "<div class='select2-result-repository clearfix'>" +
      "<div class='select2-result-repository__meta'>" +
        "<div class='select2-result-repository__id'>ID: </div>" +
        "<div class='select2-result-repository__name'>Nombre: </div>" +
        "<div class='select2-result-repository__aa'>aa: </div>" +
      "</div>" +
    "</div>"
  );


  $container.find(".select2-result-repository__id").append(repo.id);
  $container.find(".select2-result-repository__name").append(repo.name);

/*add all accesories
  var productCount = <%= @service_order.order_accessories.count.to_f %>;
  var obj = repo.accessories;
  if (obj == ""){
    $( "#accessories" ).remove();
  }

  var tbl = $("<tbody/>").attr("id","accessories");
  $("#container_accessories").append(tbl);
  for(var i=0;i<obj.length;i++)
  {
      var tr="<tr class='text-center' data_id='"+productCount+"' >";
      var td1="<td>"+obj[i]["name"]+"</td>";
      var td2="<td><input type='number' value='0' name='service_order[order_accessories_attributes]["+productCount+"][quantity]'  ></td>"
      var td3="<td><button type='button' class='btn btn-sm btn-icon btn-pure btn-outline btnDelete'><em class='fa-2x icon-close mr-2'></em></button></td></tr>";
      var hidden="<input type='hidden' value="+obj[i]["name"]+" name='service_order[order_accessories_attributes]["+productCount+"][accessory]'  >"
      
     $("#accessories").append(tr+td1+td2+hidden); 
     productCount += 1;
    
  } 
*/
  return $container;
}

function formatRepoSelection (repo) {
  if (repo.accessories !== undefined){
    var productCount = <%= @service_order.order_accessories.count.to_f %>;
    var obj = repo.accessories;
    var tbl = $("<tbody/>").attr("id","accessories");
    $("#container_accessories").html(tbl);
    for(var i=0;i<obj.length;i++)
    {
        var tr="<tr class='text-center' data_id='"+productCount+"' >";
        var td1="<td>"+obj[i]["name"]+"</td>";
        var td2="<td><input type='number' value='0' name='service_order[order_accessories_attributes]["+productCount+"][quantity]'  ></td>"
        var td3="<td><button type='button' class='btn btn-sm btn-icon btn-pure btn-outline btnDelete'><em class='fa-2x icon-close mr-2'></em></button></td></tr>";
        var hidden="<input type='hidden' value="+obj[i]["name"]+" name='service_order[order_accessories_attributes]["+productCount+"][accessory]'  >"
        
       $("#accessories").append(tr+td1+td2+hidden); 
       productCount += 1;
      
    } 
  }
  return repo.name || repo.text;
}
</script>